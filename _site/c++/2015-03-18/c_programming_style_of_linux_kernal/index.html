
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Linux kernel coding style</title>
    
    <meta name="description" content="">
    <meta name="author" content="elloop">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme --><!-- 
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet"> -->
    <!-- Optional theme --><!-- 
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-solarized-dark.css" rel="stylesheet"> -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/colors-dark.css" rel="stylesheet">
    <!-- highlighting css -->
    
        <link href="/assets/syntaxcss/monokai.css" rel="stylesheet" type="text/css" media="all">
    

    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images -->
      <link rel="shortcut icon" href="/assets/themes/bootstrap-3/favicon.png">
      <!-- <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png"> -->
   

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

</head>

<body>

    
<style type="text/css">
</style>

<div id="wrap">
    <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Small Flows</a>
            <!-- 
            <a href="http://github.com/elloop"><img class="navbar-brand" src="/assets/images/github-icon.png" alt="Star me on GitHub" /></a>
            -->
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
            <ul class="nav navbar-nav">
                  


  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">归档</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">分类</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">标签</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  




            </ul>
            <!--

                <a href="http://github.com/elloop"><img class="naviconhref" src="/assets/images/github-icon.png" alt="Star me on GitHub" /></a>

            <form action="http://www.google.com/search" class="navbar-form navbar-right" method="get">
                <div class="form-group">
                    <input class="form-control" placeholder="Google" name="q" size="31" maxlength="255" value="" type="text">
                </div>
                <input value="Search" class="btn btn-default" type="submit">
                <input style="display:none" value="http://elloop.github.io" name="sitesearch" checked="" type="radio">
            </form>
            -->
        </div>
        <!-- /.navbar-collapse -->

    </nav>

    <div class="container">
        
<div class="page-header">
  <h1>Linux kernel coding style </h1>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?6c2d2406949a760f35302c8a793d54f6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>18 March 2015</span>
    </div>

    
    <div class="content">
        <!-- copyright -->
        
            <span><b style="color: #ff8c5b"><i>版权声明：本文基于署名 2.5 中国大陆许可协议发布，欢迎转载，演绎或用于商业目的，但是必须保留本文的署名elloop(包含链接)</i></b></span> <br></br>
        

        <p>Annotation from Chris Lott:</p>

<p>This is file &#39;CodingStyle&#39; from the Linux kernel source area.</p>

<p>Of course the author is Linus Torvalds.</p>

<p>To get the most recent version of this document, see:
<a href="http://vger.samba.org/cgi-bin/cvsweb/linux/Documentation/CodingStyle?cvsroot=vger">http://vger.samba.org/cgi-bin/cvsweb/linux/Documentation/CodingStyle?cvsroot=vger</a></p>

<hr>

<p>Linux kernel coding style </p>

<p>This is a short document describing the preferred coding style for the
linux kernel.  Coding style is very personal, and I won&#39;t <em>force</em> my
views on anybody, but this is what goes for anything that I have to be
able to maintain, and I&#39;d prefer it for most other things too.  Please
at least consider the points made here. </p>

<p>First off, I&#39;d suggest printing out a copy of the GNU coding standards,
and NOT read it.  Burn them, it&#39;s a great symbolic gesture. </p>

<p>Anyway, here goes:</p>

<p>Chapter 1: Indentation</p>

<p>Tabs are 8 characters, and thus indentations are also 8 characters. 
There are heretic movements that try to make indentations 4 (or even 2!)
characters deep, and that is akin to trying to define the value of PI to
be 3. </p>

<p>Rationale: The whole idea behind indentation is to clearly define where
a block of control starts and ends.  Especially when you&#39;ve been looking
at your screen for 20 straight hours, you&#39;ll find it a lot easier to see
how the indentation works if you have large indentations. </p>

<p>Now, some people will claim that having 8-character indentations makes
the code move too far to the right, and makes it hard to read on a
80-character terminal screen.  The answer to that is that if you need
more than 3 levels of indentation, you&#39;re screwed anyway, and should fix
your program. </p>

<p>In short, 8-char indents make things easier to read, and have the added
benefit of warning you when you&#39;re nesting your functions too deep. 
Heed that warning. </p>

<p>Chapter 2: Placing Braces</p>

<p>The other issue that always comes up in C styling is the placement of
braces.  Unlike the indent size, there are few technical reasons to
choose one placement strategy over the other, but the preferred way, as
shown to us by the prophets Kernighan and Ritchie, is to put the opening
brace last on the line, and put the closing brace first, thusly:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    if (x is true) {
        we do y
    }
</code></pre></div>
<p>However, there is one special case, namely functions: they have the
opening brace at the beginning of the next line, thus:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    int function(int x)
    {
        body of function
    }
</code></pre></div>
<p>Heretic people all over the world have claimed that this inconsistency
is ...  well ...  inconsistent, but all right-thinking people know that
(a) K&amp;R are <em>right</em> and (b) K&amp;R are right.  Besides, functions are
special anyway (you can&#39;t nest them in C). </p>

<p>Note that the closing brace is empty on a line of its own, <em>except</em> in
the cases where it is followed by a continuation of the same statement,
ie a &quot;while&quot; in a do-statement or an &quot;else&quot; in an if-statement, like
this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    do {
        body of do-loop
    } while (condition);
</code></pre></div>
<p>and</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    if (x == y) {
        ..
    } else if (x &gt; y) {
        ...
    } else {
        ....
    }
</code></pre></div>
<p>Rationale: K&amp;R. </p>

<p>Also, note that this brace-placement also minimizes the number of empty
(or almost empty) lines, without any loss of readability.  Thus, as the
supply of new-lines on your screen is not a renewable resource (think
25-line terminal screens here), you have more empty lines to put
comments on. </p>

<p>Chapter 3: Naming</p>

<p>C is a Spartan language, and so should your naming be.  Unlike Modula-2
and Pascal programmers, C programmers do not use cute names like
ThisVariableIsATemporaryCounter.  A C programmer would call that
variable &quot;tmp&quot;, which is much easier to write, and not the least more
difficult to understand. </p>

<p>HOWEVER, while mixed-case names are frowned upon, descriptive names for
global variables are a must.  To call a global function &quot;foo&quot; is a
shooting offense. </p>

<p>GLOBAL variables (to be used only if you <em>really</em> need them) need to
have descriptive names, as do global functions.  If you have a function
that counts the number of active users, you should call that
&quot;count_active_users()&quot; or similar, you should <em>not</em> call it &quot;cntusr()&quot;. </p>

<p>Encoding the type of a function into the name (so-called Hungarian
notation) is brain damaged - the compiler knows the types anyway and can
check those, and it only confuses the programmer.  No wonder MicroSoft
makes buggy programs. </p>

<p>LOCAL variable names should be short, and to the point.  If you have
some random integer loop counter, it should probably be called &quot;i&quot;. 
Calling it &quot;loop_counter&quot; is non-productive, if there is no chance of it
being mis-understood.  Similarly, &quot;tmp&quot; can be just about any type of
variable that is used to hold a temporary value. </p>

<p>If you are afraid to mix up your local variable names, you have another
problem, which is called the function-growth-hormone-imbalance syndrome. 
See next chapter. </p>

<p>Chapter 4: Functions</p>

<p>Functions should be short and sweet, and do just one thing.  They should
fit on one or two screenfuls of text (the ISO/ANSI screen size is 80x24,
as we all know), and do one thing and do that well. </p>

<p>The maximum length of a function is inversely proportional to the
complexity and indentation level of that function.  So, if you have a
conceptually simple function that is just one long (but simple)
case-statement, where you have to do lots of small things for a lot of
different cases, it&#39;s OK to have a longer function. </p>

<p>However, if you have a complex function, and you suspect that a
less-than-gifted first-year high-school student might not even
understand what the function is all about, you should adhere to the
maximum limits all the more closely.  Use helper functions with
descriptive names (you can ask the compiler to in-line them if you think
it&#39;s performance-critical, and it will probably do a better job of it
that you would have done). </p>

<p>Another measure of the function is the number of local variables.  They
shouldn&#39;t exceed 5-10, or you&#39;re doing something wrong.  Re-think the
function, and split it into smaller pieces.  A human brain can
generally easily keep track of about 7 different things, anything more
and it gets confused.  You know you&#39;re brilliant, but maybe you&#39;d like
to understand what you did 2 weeks from now. </p>

<p>Chapter 5: Commenting</p>

<p>Comments are good, but there is also a danger of over-commenting.  NEVER
try to explain HOW your code works in a comment: it&#39;s much better to
write the code so that the <em>working</em> is obvious, and it&#39;s a waste of
time to explain badly written code. </p>

<p>Generally, you want your comments to tell WHAT your code does, not HOW. 
Also, try to avoid putting comments inside a function body: if the
function is so complex that you need to separately comment parts of it,
you should probably go back to chapter 4 for a while.  You can make
small comments to note or warn about something particularly clever (or
ugly), but try to avoid excess.  Instead, put the comments at the head
of the function, telling people what it does, and possibly WHY it does
it. </p>

<p>Chapter 6: You&#39;ve made a mess of it</p>

<p>That&#39;s OK, we all do.  You&#39;ve probably been told by your long-time Unix
user helper that &quot;GNU emacs&quot; automatically formats the C sources for
you, and you&#39;ve noticed that yes, it does do that, but the defaults it
uses are less than desirable (in fact, they are worse than random
typing - a infinite number of monkeys typing into GNU emacs would never
make a good program). </p>

<p>So, you can either get rid of GNU emacs, or change it to use saner
values.  To do the latter, you can stick the following in your .emacs file:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(defun linux-c-mode ()
  &quot;C mode with adjusted defaults for use with the Linux kernel.&quot;
  (interactive)
  (c-mode)
  (c-set-style &quot;K&amp;R&quot;)
  (setq c-basic-offset 8))
</code></pre></div>
<p>This will define the M-x linux-c-mode command.  When hacking on a
module, if you put the string -<em>- linux-c -</em>- somewhere on the first
two lines, this mode will be automatically invoked. Also, you may want
to add</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(setq auto-mode-alist (cons &#39;(&quot;/usr/src/linux.*/.*\\.[ch]$&quot; . linux-c-mode)
                       auto-mode-alist))
</code></pre></div>
<p>to your .emacs file if you want to have linux-c-mode switched on
automagically when you edit source files under /usr/src/linux.</p>

<p>But even if you fail in getting emacs to do sane formatting, not
everything is lost: use &quot;indent&quot;.</p>

<p>Now, again, GNU indent has the same brain dead settings that GNU emacs
has, which is why you need to give it a few command line options. 
However, that&#39;s not too bad, because even the makers of GNU indent
recognize the authority of K&amp;R (the GNU people aren&#39;t evil, they are
just severely misguided in this matter), so you just give indent the
options &quot;-kr -i8&quot; (stands for &quot;K&amp;R, 8 character indents&quot;). </p>

<p>&quot;indent&quot; has a lot of options, and especially when it comes to comment
re-formatting you may want to take a look at the manual page.  But
remember: &quot;indent&quot; is not a fix for bad programming. </p>

<p>Chapter 7: Configuration-files</p>

<p>For configuration options (arch/xxx/config.in, and all the Config.in files),
somewhat different indentation is used.</p>

<p>An indention level of 3 is used in the code, while the text in the config-
options should have an indention-level of 2 to indicate dependencies. The
latter only applies to bool/tristate options. For other options, just use
common sense. An example:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">if [ &quot;$CONFIG_EXPERIMENTAL&quot; = &quot;y&quot; ]; then
   tristate &#39;Apply nitroglycerine inside the keyboard (DANGEROUS)&#39; CONFIG_BOOM
   if [ &quot;$CONFIG_BOOM&quot; != &quot;n&quot; ]; then
      bool &#39;  Output nice messages when you explode&#39; CONFIG_CHEER
   fi
fi
</code></pre></div>
<p>Generally, CONFIG_EXPERIMENTAL should surround all options not considered
stable. All options that are known to trash data (experimental write-
support for file-systems, for instance) should be denoted (DANGEROUS), other
Experimental options should be denoted (EXPERIMENTAL).</p>

<p>Chapter 8: Data structures</p>

<p>Data structures that have visibility outside the single-threaded
environment they are created and destroyed in should always have
reference counts.  In the kernel, garbage collection doesn&#39;t exist (and
outside the kernel garbage collection is slow and inefficient), which
means that you absolutely <em>have</em> to reference count all your uses. </p>

<p>Reference counting means that you can avoid locking, and allows multiple
users to have access to the data structure in parallel - and not having
to worry about the structure suddenly going away from under them just
because they slept or did something else for a while. </p>

<p>Note that locking is <em>not</em> a replacement for reference counting. 
Locking is used to keep data structures coherent, while reference
counting is a memory management technique.  Usually both are needed, and
they are not to be confused with each other.</p>

<p>Many data structures can indeed have two levels of reference counting,
when there are users of different &quot;classes&quot;.  The subclass count counts
the number of subclass users, and decrements the global count just once
when the subclass count goes to zero.</p>

<p>Examples of this kind of &quot;multi-reference-counting&quot; can be found in
memory management (&quot;struct mm_struct&quot;: mm_users and mm_count), and in
filesystem code (&quot;struct super_block&quot;: s_count and s_active).</p>

<p>Remember: if another thread can find your data structure, and you don&#39;t
have a reference count on it, you almost certainly have a bug.</p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-book"></i></li>
      
      


  
     
    	<li><a href="/categories.html#c++-ref">
    		c++ <span>28</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
  
     
    	<li><a href="/tags.html#c++-ref">c++ <span>9</span></a></li>
     
    	<li><a href="/tags.html#coding style-ref">coding style <span>1</span></a></li>
    
  






    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/life/2015-03-15/word-learning" title="English Words Learning">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/programming/2015-03-18/url_spelling" title="Url Spelling Rules">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'elloop'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


    </div>

<nav class="footer">
    <div class="container">
        <span class="copyright">
            Content by <a href="https://github.com/elloop">elloop</a> (<a rel="licence" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Some rights reserved</a>)			
        </span>
        <p>
        </p>
    </div>
</nav>

</div>





    

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-64459285-1', 'auto');
      ga('send', 'pageview');

    </script>


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
    
</body>

</html>
