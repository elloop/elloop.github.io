---
layout: post
title: "【cocos2d-x 2.x 学习与应用总结】11: 理解CCGLProgram"
highlighter_style: solarizeddark
category: [cocos2d-x]
tags: [cocos2d-x, game]
description: ""
published: true
---

#前言

本文介绍了cocos2d-x中CCGLProgram这个类, 这篇文章假设读者已经了解OpenGL ES程序的基本渲染流程：顶点和片段着色器的源代码的编写、着色器的创建、program的创建、源代码绑定、编译、链接、OpenGL客户端-服务端传值等。CCGLProgram这个类正是对OpenGL ES渲染流程中涉及到着色器的编译、链接、传值等部分的抽象。

本文先总起介绍CCGLProgram所做的工作，然后分析其源代码实现，最后给出CCGLProgram的使用实例。

# 总体上认识CCGLProgram

CCGLProgram, 人如其名，它是一个OpenGL Program，通过一个顶点着色器和一个片段着色器代码（对于不支持shader即时编译功能的显卡，传入编译好的二进制着色器数据）来创建一个CCGLProgram.

CCGLProgram内部做下面这些工作：

- compileShader方法，内部调用glCreateShader, glShaderSource, glCompileShader等OpenGL API创建建顶点和片段着色器, 并编译

- 调用glCreateProgram等OpenGL API完成program创建

- link方法调用glLinkProgram完成program的链接

- use方法调用glUseProgram以启用program

- 定义了8个预定义的uniform，

<!--more-->

```c++
#define kCCUniformPMatrix_s				"CC_PMatrix"
#define kCCUniformMVMatrix_s			"CC_MVMatrix"
#define kCCUniformMVPMatrix_s			"CC_MVPMatrix"
#define kCCUniformTime_s				"CC_Time"
#define kCCUniformSinTime_s				"CC_SinTime"
#define kCCUniformCosTime_s				"CC_CosTime"
#define kCCUniformRandom01_s			"CC_Random01"
#define kCCUniformSampler_s				"CC_Texture0"
#define kCCUniformAlphaTestValue		"CC_alpha_value"
```

- updateUniforms方法，完成预定义的8个uniform的绑定

- setUniformsForBuiltins方法完成在绘制开始时，给预定义的uniform的传值工作

- `setUniformLocationWith_<n>_[fiv]`系列方法完成客户端数值上传到OpenGL服务器

- 使用一个哈希表`m_pHashForUniforms`作为缓存，保存每一个uniform的值，如果不发生变化就不会重复上传该uniform的值到OpenGL服务器

# CCGLProgram代码分析

# CCGLProgram使用实例

---------------------------

**作者水平有限，对相关知识的理解和总结难免有错误，还望给予指正，非常感谢！**

**在这里也能看到这篇文章：[github博客](http://elloop.github.io), [CSDN博客](http://blog.csdn.net/elloop), 欢迎访问**

