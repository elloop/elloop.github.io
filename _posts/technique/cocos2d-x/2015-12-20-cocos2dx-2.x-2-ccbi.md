---
layout: post
title: "【cocos2d-x 3.x 学习与应用总结】2: 在cocos2d-x中使用ccbi"
highlighter_style: solarizeddark
category: [cocos2d-x]
tags: [cocos2d-x, game]
description: ""
published: true
---

#前言

本文以3.9版本的cocos2d-x为例，总结了如何在代码中解析、加载ccbi文件。给出一个最简单的使用ccbi实现的helloworld的例子，接着给出一个更加贴近实际项目应用中的ccbi使用示例, 并结合示例分析ccbi的解析过程。

<!--more-->

# 官方示例程序

## ccbi功能支持的源代码

cocos对ccbi的支持是在extensions这个模块里面，以v3.9为例，解析ccbi的代码的物理路径是放在cocos2d/cocos/editor-support/cocosbuilde这个路径下面，在vs的解决方案管理器中如下图所示：

![ccbreader_codes.png](http://7xi3zl.com1.z0.glb.clouddn.com/ccbreader_codes.png)

## 官方示例源代码

cocos官方的ccbi使用示例代码是在（vs中）：TestCpp/ExtensionsTest/CocosBuilderTest这个分组下面, 
其中CocosBuilderTest.cpp的实现如下，init方法是解析加载ccbi的关键代码：

```c++
#include "CocosBuilderTest.h"
#include "../../testResource.h"
#include "HelloCocosBuilder/HelloCocosBuilderLayerLoader.h"

USING_NS_CC;
USING_NS_CC_EXT;
using namespace cocosbuilder;

CocosBuilderTests::CocosBuilderTests()
{
    ADD_TEST_CASE(CocosBuilderTestScene);
}

bool CocosBuilderTestScene::init() {
    if (TestCase::init())
    {
        /* Create an autorelease NodeLoaderLibrary. */
        auto nodeLoaderLibrary = NodeLoaderLibrary::newDefaultNodeLoaderLibrary();

        nodeLoaderLibrary->registerNodeLoader("HelloCocosBuilderLayer", HelloCocosBuilderLayerLoader::loader());

        /* Create an autorelease CCBReader. */
        cocosbuilder::CCBReader * ccbReader = new cocosbuilder::CCBReader(nodeLoaderLibrary);

        /* Read a ccbi file. */
        auto node = ccbReader->readNodeGraphFromFile("ccb/HelloCocosBuilder.ccbi", this);

        ccbReader->release();

        if (node != nullptr) {
            this->addChild(node);
        }

        return true;
    }

    return false;
}
```

示例代码中包括了动画、UI按钮、菜单、标签、粒子、Scrollview等相关示例，这里不贴代码了，需要的话去cpptests工程里看就行了。

下面以我的实际使用经验总结一下在实际项目中该如何使用ccbi，先从一个HelloWorld说起。

# 使用ccbi的HelloWorld

## 使用cocosbuilder创建一个简单的ccbi

![cocos_builder.png](http://7xi3zl.com1.z0.glb.clouddn.com/cocos_builder.png)

## 创建一个最简单的class，来使用创建出来的ccbi文件：

**CcbiHelloWorld.h**: 定义了一个class继承自Node，用来挂载ccbi

```c++
#ifndef PLAYING_WITH_COCOS3D_PAGE_CCB_HELLOWORLD_H
#define PLAYING_WITH_COCOS3D_PAGE_CCB_HELLOWORLD_H

#include "cocos2d.h"
#include "cocosbuilder/CocosBuilder.h"

class CcbiHelloWorld : public cocos2d::Node
{
public:
    CREATE_FUNC(CcbiHelloWorld);
    bool init() override
    {
        using cocosbuilder::NodeLoaderLibrary;
        using cocosbuilder::CCBReader;

        // 第一步： 创建一个NodeLoaderLibrary
        auto loaderLib = NodeLoaderLibrary::newDefaultNodeLoaderLibrary();

        // 第二步: 创建CCBReader
        auto ccbReader = new CCBReader(loaderLib);

        // 第三步： 调用CCBReader的readNodeGraphFromFile的方法，传入ccbi名字
        auto node = ccbReader->readNodeGraphFromFile("ccbi/baozao.ccbi", this);
        ccbReader->release();

        // 解析完毕，可以使用Node了。
        if ( node )
        {
            addChild(node);
        }
        return true;
    }
};

#endif  //PLAYING_WITH_COCOS3D_PAGE_CCB_HELLOWORLD_H
```

在AppDelegate的applicationDidFinishLaunching()方法结尾处，添加启动代码：

```c++
auto node = CcbiHelloWorld::create();
auto scene = Scene::create();
scene->addChild(node);
director->runWithScene(scene);
```

编译运行，一个最简单的使用ccbi的例子就跑起来了，如下图所示：

![ccbi_hello_world2.png](http://7xi3zl.com1.z0.glb.clouddn.com/ccbi_hello_world2.png)

# 一个更加使用的ccbi使用方法及ccbi解析过程分析

![CCBPage.jpg](http://7xi3zl.com1.z0.glb.clouddn.com/CCBPage.jpg)



---------------------------
**作者水平有限，对相关知识的理解和总结难免有错误，还望给予指正，非常感谢！**

**欢迎访问[CSDN博客](http://blog.csdn.net/elloop)，与本站同步更新**

